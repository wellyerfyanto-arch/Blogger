{% extends "base.html" %}

{% block title %}Dashboard - Auto Posting Blog{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="stats-grid">
        <!-- Existing stats cards remain the same -->
        <div class="stat-card">
            <h3>Total Posts</h3>
            <p class="stat-number">{{ stats.total_posts }}</p>
        </div>
        <div class="stat-card">
            <h3>Published</h3>
            <p class="stat-number">{{ stats.published_posts }}</p>
        </div>
        <div class="stat-card">
            <h3>Scheduled</h3>
            <p class="stat-number">{{ stats.scheduled_posts }}</p>
        </div>
        <div class="stat-card">
            <h3>Pending Titles</h3>
            <p class="stat-number">{{ stats.pending_titles }}</p>
        </div>
        <div class="stat-card">
            <h3>Failed</h3>
            <p class="stat-number">{{ stats.failed_posts }}</p>
        </div>
        <div class="stat-card">
            <h3>API Status</h3>
            <p class="stat-number {% if stats.api_configured %}status-good{% else %}status-bad{% endif %}">
                {{ stats.api_configured and '‚úÖ' or '‚ùå' }}
            </p>
        </div>
    </div>

    <div class="actions-grid">
        <!-- Single Post Creation -->
        <div class="action-card">
            <h3>üìù Create Single Post</h3>
            <div class="post-options">
                <button id="showScheduleForm" class="btn-option active">Schedule Post</button>
                <button id="showImmediateForm" class="btn-option">Post Immediately</button>
            </div>
            
            <!-- Schedule Post Form -->
            <form id="schedulePostForm" class="post-form">
                <div class="form-group">
                    <label for="scheduleTitle">Title:</label>
                    <input type="text" id="scheduleTitle" name="title" required placeholder="Enter post title">
                </div>
                <div class="form-group">
                    <label for="scheduleKeywords">Keywords (comma separated):</label>
                    <input type="text" id="scheduleKeywords" name="keywords" placeholder="keyword1, keyword2, keyword3">
                </div>
                <div class="form-group">
                    <label for="scheduleDate">Publish Date:</label>
                    <input type="datetime-local" id="scheduleDate" name="publish_date" required>
                </div>
                <button type="submit" class="btn-primary">Schedule Post</button>
            </form>
            
            <!-- Immediate Post Form -->
            <form id="immediatePostForm" class="post-form" style="display: none;">
                <div class="form-group">
                    <label for="immediateTitle">Title:</label>
                    <input type="text" id="immediateTitle" name="title" required placeholder="Enter post title">
                </div>
                <div class="form-group">
                    <label for="immediateKeywords">Keywords (comma separated):</label>
                    <input type="text" id="immediateKeywords" name="keywords" placeholder="keyword1, keyword2, keyword3">
                </div>
                <div class="form-info">
                    <p>üì¢ This post will be published immediately to your blog!</p>
                </div>
                <button type="submit" class="btn-primary btn-immediate">Publish Now</button>
            </form>
        </div>

        <!-- Bulk Upload Card -->
        <div class="action-card">
            <h3>üì§ Upload Bulk Titles</h3>
            <div class="upload-options">
                <button id="showBulkSchedule" class="btn-option active">Schedule Bulk</button>
                <button id="showBulkImmediate" class="btn-option">Publish Bulk Immediately</button>
            </div>
            
            <!-- Bulk Schedule Form -->
            <div id="bulkScheduleSection">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="fileInput">Select CSV or TXT file:</label>
                        <input type="file" id="fileInput" name="file" accept=".csv,.txt" required>
                    </div>
                    <button type="submit" class="btn-primary">Upload & Schedule</button>
                </form>
                <div class="sample-links">
                    <p>Download sample files:</p>
                    <a href="{{ url_for('serve_sample_file', filename='sample_titles.csv') }}">Sample CSV</a>
                    <a href="{{ url_for('serve_sample_file', filename='sample_titles.txt') }}">Sample TXT</a>
                </div>
            </div>
            
            <!-- Bulk Immediate Form -->
            <div id="bulkImmediateSection" style="display: none;">
                <form id="bulkImmediateForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="bulkImmediateFile">Select CSV or TXT file:</label>
                        <input type="file" id="bulkImmediateFile" name="file" accept=".csv,.txt" required>
                    </div>
                    <div class="form-info">
                        <p>üöÄ All titles will be published immediately to your blog!</p>
                        <p><small>Note: This may take several minutes depending on the number of titles.</small></p>
                    </div>
                    <button type="submit" class="btn-primary btn-immediate">Publish All Now</button>
                </form>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="action-card">
            <h3>‚ö° Quick Actions</h3>
            <div class="quick-actions">
                <button id="scheduleBulkBtn" class="btn-secondary">
                    üìÖ Schedule All Pending
                </button>
                <button id="publishPendingBtn" class="btn-immediate">
                    üöÄ Publish All Pending Now
                </button>
                <button id="triggerSchedulerBtn" class="btn-secondary">
                    üîÑ Run Scheduler Now
                </button>
            </div>
            
            <div class="scheduler-status">
                <h4>Scheduler Status:</h4>
                <div id="schedulerStatus">
                    <p>Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal for Bulk Operations -->
    <div id="progressModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>üîÑ Processing Posts</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">Initializing...</p>
            <div id="progressResults" class="progress-results"></div>
            <button id="closeProgress" class="btn-secondary" style="display: none;">Close</button>
        </div>
    </div>

    <!-- Existing content sections remain the same -->
    <div class="content-section">
        <h2>Recent Posts</h2>
        <div class="posts-list">
            {% for post in posts %}
            <div class="post-item {% if post.status == 'published' %}status-published{% elif post.status == 'scheduled' %}status-scheduled{% else %}status-failed{% endif %}">
                <h4>{{ post.title }}</h4>
                <p class="post-meta">
                    Status: <strong>{{ post.status }}</strong> | 
                    Type: <strong>{{ post.type or 'scheduled' }}</strong> |
                    Created: {{ post.created_at[:10] }}
                    {% if post.published_at %} | Published: {{ post.published_at[:10] }}{% endif %}
                </p>
                {% if post.url %}
                <a href="{{ post.url }}" target="_blank" class="post-link">View Post</a>
                {% endif %}
            </div>
            {% else %}
            <p class="no-data">No posts yet. Create your first post!</p>
            {% endfor %}
        </div>
    </div>

    {% if bulk_titles %}
    <div class="content-section">
        <h2>Recent Bulk Titles</h2>
        <div class="titles-list">
            {% for title in bulk_titles %}
            <div class="title-item {% if title.status == 'scheduled' %}status-scheduled{% else %}status-pending{% endif %}">
                <p>{{ title.title }}</p>
                <small>Added: {{ title.added_at[:10] }} | Status: {{ title.status }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
// Post Type Toggle
document.getElementById('showScheduleForm').addEventListener('click', function() {
    document.getElementById('schedulePostForm').style.display = 'block';
    document.getElementById('immediatePostForm').style.display = 'none';
    this.classList.add('active');
    document.getElementById('showImmediateForm').classList.remove('active');
});

document.getElementById('showImmediateForm').addEventListener('click', function() {
    document.getElementById('schedulePostForm').style.display = 'none';
    document.getElementById('immediatePostForm').style.display = 'block';
    this.classList.add('active');
    document.getElementById('showScheduleForm').classList.remove('active');
});

// Bulk Type Toggle
document.getElementById('showBulkSchedule').addEventListener('click', function() {
    document.getElementById('bulkScheduleSection').style.display = 'block';
    document.getElementById('bulkImmediateSection').style.display = 'none';
    this.classList.add('active');
    document.getElementById('showBulkImmediate').classList.remove('active');
});

document.getElementById('showBulkImmediate').addEventListener('click', function() {
    document.getElementById('bulkScheduleSection').style.display = 'none';
    document.getElementById('bulkImmediateSection').style.display = 'block';
    this.classList.add('active');
    document.getElementById('showBulkSchedule').classList.remove('active');
});

// Set default datetime for schedule form
const now = new Date();
now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
document.getElementById('scheduleDate').value = now.toISOString().slice(0, 16);

// Single Post - Schedule
document.getElementById('schedulePostForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        title: document.getElementById('scheduleTitle').value,
        keywords: document.getElementById('scheduleKeywords').value.split(',').map(k => k.trim()).filter(k => k),
        publish_date: document.getElementById('scheduleDate').value
    };
    
    fetch('/api/posts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('‚úÖ Post scheduled successfully!');
            this.reset();
            location.reload();
        }
    })
    .catch(error => {
        alert('Error scheduling post: ' + error);
    });
});

// Single Post - Immediate
document.getElementById('immediatePostForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        title: document.getElementById('immediateTitle').value,
        keywords: document.getElementById('immediateKeywords').value.split(',').map(k => k.trim()).filter(k => k)
    };
    
    showProgressModal('Publishing post...');
    
    fetch('/api/posts/immediate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            hideProgressModal();
            alert('Error: ' + data.error);
        } else {
            updateProgress('‚úÖ Post published successfully!', 100);
            document.getElementById('closeProgress').style.display = 'block';
            this.reset();
            setTimeout(() => {
                hideProgressModal();
                location.reload();
            }, 2000);
        }
    })
    .catch(error => {
        hideProgressModal();
        alert('Error publishing post: ' + error);
    });
});

// Bulk Upload - Schedule (existing)
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData();
    formData.append('file', document.getElementById('fileInput').files[0]);
    
    fetch('/api/bulk-upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('Success: ' + data.message);
            location.reload();
        }
    })
    .catch(error => {
        alert('Upload failed: ' + error);
    });
});

// Bulk Upload - Immediate
document.getElementById('bulkImmediateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const file = document.getElementById('bulkImmediateFile').files[0];
    if (!file) {
        alert('Please select a file');
        return;
    }
    
    showProgressModal('Reading file...');
    updateProgress('Processing file...', 10);
    
    // Read and process file
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            let titles = [];
            let keywords_map = {};
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                // Simple CSV parsing
                const lines = content.split('\n');
                const headers = lines[0].toLowerCase().split(',');
                const titleIndex = headers.findIndex(h => h.includes('title'));
                const keywordIndex = headers.findIndex(h => h.includes('keyword'));
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const cells = lines[i].split(',');
                        if (cells[titleIndex]) {
                            const title = cells[titleIndex].trim();
                            titles.push(title);
                            if (keywordIndex !== -1 && cells[keywordIndex]) {
                                keywords_map[title] = cells[keywordIndex].split(',').map(k => k.trim()).filter(k => k);
                            }
                        }
                    }
                }
            } else {
                // TXT file
                titles = content.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && !line.startsWith('#'));
            }
            
            if (titles.length === 0) {
                hideProgressModal();
                alert('No valid titles found in the file.');
                return;
            }
            
            updateProgress(`Found ${titles.length} titles. Starting publication...`, 30);
            
            // Send to bulk immediate endpoint
            fetch('/api/posts/bulk-immediate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    titles: titles,
                    keywords_map: keywords_map
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    hideProgressModal();
                    alert('Error: ' + data.error);
                } else {
                    updateProgress('Publication completed!', 100);
                    
                    // Show results
                    const results = data.results;
                    let resultsHtml = `
                        <div class="results-summary">
                            <h4>Publication Results:</h4>
                            <p>‚úÖ Successful: ${results.successful.length}</p>
                            <p>‚ùå Failed: ${results.failed.length}</p>
                            <p>üìä Total: ${results.total}</p>
                        </div>
                    `;
                    
                    if (results.failed.length > 0) {
                        resultsHtml += '<div class="failed-list"><h5>Failed Posts:</h5>';
                        results.failed.forEach(failed => {
                            resultsHtml += `<p>‚ùå ${failed.title}: ${failed.error}</p>`;
                        });
                        resultsHtml += '</div>';
                    }
                    
                    document.getElementById('progressResults').innerHTML = resultsHtml;
                    document.getElementById('closeProgress').style.display = 'block';
                    
                    // Auto reload after 5 seconds if all successful
                    if (results.failed.length === 0) {
                        setTimeout(() => {
                            hideProgressModal();
                            location.reload();
                        }, 5000);
                    }
                }
            })
            .catch(error => {
                hideProgressModal();
                alert('Error: ' + error);
            });
            
        } catch (error) {
            hideProgressModal();
            alert('Error processing file: ' + error);
        }
    };
    
    reader.readAsText(file);
});

// Publish All Pending
document.getElementById('publishPendingBtn').addEventListener('click', function() {
    const pendingTitles = {{ auto_poster.bulk_titles | selectattr('status', 'equalto', 'pending') | list | tojson | safe }};
    
    if (pendingTitles.length === 0) {
        alert('No pending titles to publish.');
        return;
    }
    
    if (!confirm(`Publish ${pendingTitles.length} pending titles immediately? This may take several minutes.`)) {
        return;
    }
    
    showProgressModal('Preparing to publish pending titles...');
    
    const titles = pendingTitles.map(t => t.title);
    const keywords_map = {};
    pendingTitles.forEach(t => {
        if (t.keywords && t.keywords.length > 0) {
            keywords_map[t.title] = t.keywords;
        }
    });
    
    updateProgress(`Starting publication of ${titles.length} titles...`, 10);
    
    fetch('/api/posts/bulk-immediate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            titles: titles,
            keywords_map: keywords_map
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            hideProgressModal();
            alert('Error: ' + data.error);
        } else {
            updateProgress('Publication completed!', 100);
            
            const results = data.results;
            let resultsHtml = `
                <div class="results-summary">
                    <h4>Publication Results:</h4>
                    <p>‚úÖ Successful: ${results.successful.length}</p>
                    <p>‚ùå Failed: ${results.failed.length}</p>
                </div>
            `;
            
            if (results.failed.length > 0) {
                resultsHtml += '<div class="failed-list"><h5>Failed Posts:</h5>';
                results.failed.forEach(failed => {
                    resultsHtml += `<p>‚ùå ${failed.title}: ${failed.error}</p>`;
                });
                resultsHtml += '</div>';
            }
            
            document.getElementById('progressResults').innerHTML = resultsHtml;
            document.getElementById('closeProgress').style.display = 'block';
            
            // Update pending titles status
            setTimeout(() => {
                fetch('/api/schedule-bulk', { method: 'POST' })
                .then(() => {
                    setTimeout(() => {
                        hideProgressModal();
                        location.reload();
                    }, 3000);
                });
            }, 2000);
        }
    })
    .catch(error => {
        hideProgressModal();
        alert('Error: ' + error);
    });
});

// Existing functions remain the same
document.getElementById('scheduleBulkBtn').addEventListener('click', function() {
    fetch('/api/schedule-bulk', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('Success: ' + data.message);
            location.reload();
        }
    });
});

// Progress Modal Functions
function showProgressModal(message) {
    document.getElementById('progressModal').style.display = 'block';
    document.getElementById('progressText').textContent = message;
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('progressResults').innerHTML = '';
    document.getElementById('closeProgress').style.display = 'none';
}

function hideProgressModal() {
    document.getElementById('progressModal').style.display = 'none';
}

function updateProgress(message, percent) {
    document.getElementById('progressText').textContent = message;
    document.getElementById('progressFill').style.width = percent + '%';
}

document.getElementById('closeProgress').addEventListener('click', hideProgressModal);

// Close modal when clicking outside
window.addEventListener('click', function(event) {
    const modal = document.getElementById('progressModal');
    if (event.target === modal) {
        hideProgressModal();
    }
});

// Load scheduler status
function loadSchedulerStatus() {
    fetch('/api/scheduler/status')
    .then(response => response.json())
    .then(data => {
        const statusDiv = document.getElementById('schedulerStatus');
        if (data.error) {
            statusDiv.innerHTML = '<p>Error loading status</p>';
        } else {
            statusDiv.innerHTML = `
                <p><strong>Status:</strong> ${data.scheduler_active ? '‚úÖ Active' : '‚ùå Inactive'}</p>
                <p><strong>Next Run:</strong> ${data.next_run}</p>
                <p><strong>Scheduled Posts:</strong> ${data.scheduled_posts_count}</p>
                <p><strong>Pending Titles:</strong> ${data.pending_bulk_titles}</p>
            `;
        }
    });
}

document.getElementById('triggerSchedulerBtn').addEventListener('click', function() {
    fetch('/api/scheduler/trigger', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert('Success: ' + data.message);
            loadSchedulerStatus();
        }
    });
});

// Load initial status
loadSchedulerStatus();
setInterval(loadSchedulerStatus, 30000);
</script>
{% endblock %}
